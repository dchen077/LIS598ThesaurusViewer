<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>LIS598 ThesaurusViewer</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div id="container">
        <div id="treeContainer"></div>
        <div id="content">
            <h2>Details Panel</h2>
            <p>Select a term from the hierarchical list on the left to view details here.</p>
        </div>
    </div>
    <div id="sprite-container">
        <div id="speech-bubble">Bring me to the magical world of <a href="https://github.com/dchen077/LIS598ThesaurusViewer" target="_blank">GitHub</a>!</div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script>
        const csvUrl = "https://raw.githubusercontent.com/dchen077/LIS598ThesaurusViewer/refs/heads/main/dataset/coffee.csv";

        let csvData;

        // Function to parse CSV using PapaParse library
        function parseCSV(csvText) {
            const results = Papa.parse(csvText, {
                header: false,
                skipEmptyLines: true,
                trimHeaders: true
            });
            return results.data;
        }

        // Function to build a hierarchical tree from parsed CSV data
        function buildFilteredTree(data) {
            const tree = {};
            let startIndex = 0;

            if (data.length && data[0].some(cell => cell.toLowerCase().includes("concept"))) {
                startIndex = 1;
            }

            for (let i = startIndex; i < data.length; i++) {
                let current = tree;
                let lastFilledIndex = data[i].length - 2; // Exclude related terms column
                while (lastFilledIndex >= 0 && !data[i][lastFilledIndex]) {
                    lastFilledIndex--;
                }

                if (lastFilledIndex < 0) continue;

                for (let j = 0; j < lastFilledIndex; j++) {
                    if (!data[i][j]) continue;
                    if (!current[data[i][j]]) {
                        current[data[i][j]] = {};
                    }
                    current = current[data[i][j]];
                }

                if (data[i][lastFilledIndex]) {
                    current[data[i][lastFilledIndex]] = null;
                }
            }
            return tree;
        }

        // Function to create the hierarchical tree view and attach event listeners
        function createTreeView(node, broaderTerms = [], data) {
            const ul = document.createElement('ul');
            for (const key in node) {
                const li = document.createElement('li');
                const newBroaderTerms = [...broaderTerms, key];

                if (node[key] !== null) {
                    const span = document.createElement('span');
                    span.classList.add('caret');
                    span.textContent = key;
                    span.addEventListener("click", function () {
                        updateDetailsPanel(key, newBroaderTerms, data); // Update the details panel on click
                    });
                    li.appendChild(span);
                    li.appendChild(createTreeView(node[key], newBroaderTerms, data));
                } else {
                    li.textContent = key;
                    li.addEventListener("click", function () {
                        updateDetailsPanel(key, newBroaderTerms, data); // Update the details panel on click
                    });
                }
                ul.appendChild(li);
            }
            ul.classList.add('nested');
            return ul;
        }

        // Function to find narrower terms for a given term
        function findNarrowerTerms(data, term) {
            const narrowerTerms = new Set();

            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                let lastIndex = row.length - 2;
                while (lastIndex >= 0 && !row[lastIndex]) {
                    lastIndex--;
                }

                if (lastIndex > 0 && row[lastIndex - 1] === term) {
                    narrowerTerms.add(row[lastIndex]);
                }
            }
            return Array.from(narrowerTerms);
        }

        // Function to update the details panel with broader terms and narrower terms
        function updateDetailsPanel(key, broaderTerms, data) {
            document.getElementById("content").innerHTML = `<h2>${key}</h2><p><strong>Broader Terms:</strong> ${broaderTerms.slice(0, -1).join(", ")}</p>`;
            const narrowerTerms = findNarrowerTerms(data, key);
            if (narrowerTerms.length > 0) {
                document.getElementById("content").innerHTML += `<p><strong>Narrower Terms:</strong> ${narrowerTerms.join(", ")}</p>`;
            }
        }

        // Function to add toggle functionality for the tree view
        function addToggleFunctionality() {
            const togglers = document.getElementsByClassName("caret");
            for (let i = 0; i < togglers.length; i++) {
                togglers[i].addEventListener("click", function () {
                    const nested = this.parentElement.querySelector(".nested");
                    if (nested) {
                        nested.classList.toggle("active");
                        this.classList.toggle("caret-down");
                    }
                });
            }
        }

        // Function to fetch CSV from GitHub and initialize the tree view
        function loadCSVFromGitHub(url) {
            fetch(url)
                .then(response => response.text())
                .then(csvText => {
                    csvData = parseCSV(csvText); // Store parsed CSV data in global variable
                    const treeData = buildFilteredTree(csvData);
                    const treeContainer = document.getElementById('treeContainer');
                    treeContainer.innerHTML = "";
                    const treeView = createTreeView(treeData, [], csvData); // Pass the CSV data to createTreeView
                    treeView.classList.remove("nested");
                    treeContainer.appendChild(treeView);
                    addToggleFunctionality();
                })
                .catch(error => {
                    document.getElementById('treeContainer').textContent = "Error fetching CSV file: " + error.message;
                });
        }

        // Load CSV and initialize tree view on page load
        window.addEventListener("load", function () {
            loadCSVFromGitHub(csvUrl);
        });
    </script>
</body>
</html>



